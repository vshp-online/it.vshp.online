# МДК.11.01 - Практический экзамен - Вариант №2

## База данных книжного магазина

Вы работаете с базой данных книжного магазина, который ведёт учёт книг, авторов, поставщиков и продаж. Ваша задача — дополнить существующую базу данных необходимыми объектами, написать SQL-скрипты для выполнения операций над базой данных и продемонстрировать использование хранимых процедур, пользовательских функций, триггеров и представлений.

## Готовая база данных

**Имя базы:** `bookstore_db`

**Таблицы и данные:**

1. **`books`** — информация о книгах

   | id  | title                    | author_id | supplier_id | price  | stock |
   |-----|--------------------------|-----------|-------------|--------|-------|
   | 1   | Война и мир              | 1         | 1           | 500.00 | 20    |
   | 2   | Преступление и наказание | 2         | 2           | 300.00 | 15    |
   | 3   | Мастер и Маргарита       | 3         | 1           | 400.00 | 10    |

2. **`authors`** — информация об авторах

   | id  | name              | birth_date  |
   |-----|-------------------|-------------|
   | 1   | Лев Толстой       | 1828-09-09  |
   | 2   | Фёдор Достоевский | 1821-11-11  |
   | 3   | Михаил Булгаков   | 1891-05-15  |

3. **`suppliers`** — информация о поставщиках

   | id  | name               | contact_person | phone      |
   |-----|--------------------|----------------|------------|
   | 1   | ООО "Книжный Мир"  | Иван Иванов    | 8005551234 |
   | 2   | ИП "Книги для всех"| Пётр Петров    | 8005555678 |

4. **`sales`** — учёт продаж (изначально пустая)

   | id  | book_id | sale_date  | quantity | total |
   |-----|---------|------------|----------|-------|

5. **`change_logs`** — журнал изменений в системе

   | id  | entity_id | old_value | new_value | change_time |
   |-----|-----------|-----------|-----------|-------------|

Для создания соответствующей БД используйте SQL-скрипт:

::: details bookstore_db.sql

@[code sql:collapsed-lines=5](./includes/exam_var_2_data.sql)

:::

## Задачи

1. **Разработать хранимую процедуру `sell_book`**:
   - **Параметры:**
     - `p_book_id` — идентификатор книги.
     - `p_quantity` — количество проданных книг.
   - **Логика работы:**
     - Проверяет, существует ли книга в таблице `books`.
       - Если книга не найдена, возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Книга не найдена';
         ```

     - Проверяет, достаточно ли книг на складе.
       - Если книг не хватает, возвращает варнинг:

         ```sql
         SIGNAL SQLSTATE '01000' SET MESSAGE_TEXT = 'Недостаточно книг на складе';
         ```

       - Продажа не осуществляется.
     - Если проверки прошли успешно:
       - Уменьшает количество книг на складе (`stock`) в таблице `books`.
       - Добавляет запись о продаже в таблицу `sales` с вычислением общей суммы (`total = price * quantity`).
       - Логирует успешную продажу в таблицу `sales`.
       - Все действия должны быть реализованы с использованием транзакции.
     - В случае любой другой ошибки откатывает транзакцию.

2. **Создать пользовательскую функцию `get_books_by_supplier`**:
   - **Параметр:**
     - `p_supplier_id` — идентификатор поставщика.
   - **Возвращает:** количество книг, поставленных указанным поставщиком.
   - Если поставщик не найден, функция возвращает `0` без генерации ошибок.

3. **Создать триггер `log_stock_update` для таблицы `books`**:
   - **Срабатывает:**
     - При изменении значения `stock` (например, при продаже книги).
   - **Действие:**
     - Логирует изменения в таблицу `change_logs`.
     - Записывает:
       - `entity_id` — ID книги.
       - `old_value` — предыдущее количество на складе.
       - `new_value` — новое количество на складе.
       - `change_time` — момент изменения.

4. **Создать представление `supplier_sales_summary`**:
   - **Выводит:**
     - `supplier_name` — название поставщика.
     - `total_books` — общее количество книг, проданных этим поставщиком.
     - `total_revenue` — общий доход от продаж книг этого поставщика.
   - **Логика работы:** объединяет данные из таблиц `suppliers`, `books` и `sales`.

## Результат

Задание должно быть выполнено в локальной файловой системе компьютера. Папка со всеми файлами задания должна называться:

__`МДК.11.01 - Вариант 2 - Иванов И.И.`__

где вместо `Иванов И.И.` должны быть указаны фамилия и инициалы сдающего.

Результат выполнения задания должен быть оформлен в виде файлов:

1. Файл дампа итоговой базы данных с созданными объектами (хранимая процедура, триггер, функция, представление) и внесёнными изменениями. Должен называться `db_2.sql`.
2. Файл с последовательными SQL-запросами для тестирования каждого объекта. Должен называться `task_2.sql`.

::: details Пример содержимого файла `task_2.sql`

@[code sql:collapsed-lines=5](./includes/exam_task_2.sql)

:::
