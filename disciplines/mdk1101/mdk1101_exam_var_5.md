# МДК.11.01 - Практический экзамен - Вариант №5

## База данных ресторана

Вы работаете с базой данных ресторана, который ведёт учёт столов, клиентов, официантов и заказов. Ваша задача — дополнить существующую базу данных необходимыми объектами, написать SQL-скрипты для выполнения операций над базой данных и продемонстрировать использование хранимых процедур, пользовательских функций, триггеров и представлений.

## Готовая база данных

**Имя базы:** `restaurant_db`

**Таблицы и данные:**

1. **`tables`** — информация о столах

   | id  | table_number | capacity | status     |
   |-----|--------------|----------|------------|
   | 1   | 1            | 4        | available  |
   | 2   | 2            | 2        | available  |
   | 3   | 3            | 6        | available  |

2. **`clients`** — информация о клиентах

   | id  | full_name         | phone         |
   |-----|-------------------|---------------|
   | 1   | Иван Иванов       | 8007001111    |
   | 2   | Мария Смирнова    | 8007002222    |

3. **`waiters`** — информация об официантах

   | id  | full_name         | phone         | salary   |
   |-----|-------------------|---------------|----------|
   | 1   | Анна Кузнецова    | 8005551234    | 50000.00 |
   | 2   | Сергей Волков     | 8005555678    | 48000.00 |

4. **`orders`** — информация о заказах (изначально пустая)

   | id  | table_id | client_id | waiter_id | order_time | total_cost |
   |-----|----------|-----------|-----------|------------|------------|

5. **`change_logs`** — журнал изменений в системе

   | id  | entity_id | old_value | new_value | change_time |
   |-----|-----------|-----------|-----------|-------------|

Для создания соответствующей БД используйте SQL-скрипт:

::: details restaurant_db.sql

@[code sql:collapsed-lines=5](./includes/exam_var_5_data.sql)

:::

## Задачи

1. **Разработать хранимую процедуру `place_order`**:
   - **Параметры:**
     - `p_table_id` — идентификатор стола.
     - `p_client_id` — идентификатор клиента.
     - `p_waiter_id` — идентификатор официанта.
     - `p_total_cost` — общая сумма заказа.
   - **Логика работы:**
     - Проверяет существование стола, клиента и официанта.
       - Если стол, клиент или официант не найдены, возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Стол, клиент или официант не найдены';
         ```

     - Проверяет, свободен ли стол для заказа (статус `available`).
       - Если стол занят (`occupied`), возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Стол уже занят';
         ```

     - **Если проверки прошли успешно**:
       - Добавляет запись о заказе в таблицу `orders`.
       - Обновляет статус стола на `occupied` в таблице `tables`.
       - Все действия должны быть **реализованы с использованием транзакции**.
     - **В случае любой ошибки откатывает транзакцию.**

2. **Создать пользовательскую функцию `calculate_waiter_earnings`**:
   - **Параметр:**
     - `p_waiter_id` — идентификатор официанта.
   - **Возвращает:** суммарный заработок официанта с учётом заказов (предполагается, что официант получает 10% от суммы заказа).
   - Если официант не найден, функция возвращает `0` без генерации ошибок.

3. **Создать триггер `log_table_status_update` для таблицы `tables`**:
   - **Срабатывает:**
     - При изменении статуса стола.
   - **Действие:**
     - Логирует изменения в таблицу `change_logs`.
     - Записывает:
       - `entity_id` — ID стола.
       - `old_value` — предыдущий статус (`available` или `occupied`).
       - `new_value` — новый статус (`available` или `occupied`).
       - `change_time` — момент изменения.

4. **Создать представление `waiter_orders_summary`**:
   - **Выводит:**
     - `waiter_name` — ФИО официанта.
     - `total_orders` — количество выполненных заказов.
     - `total_earnings` — общая сумма заработка официанта.
   - **Логика работы:** объединяет данные из таблиц `waiters` и `orders`.

## Результат

Задание должно быть выполнено в локальной файловой системе компьютера. Папка со всеми файлами задания должна называться:

__`МДК.11.01 - Вариант 5 - Иванов И.И.`__

где вместо `Иванов И.И.` должны быть указаны фамилия и инициалы сдающего.

Результат выполнения задания должен быть оформлен в виде файлов:

1. Файл дампа итоговой базы данных с созданными объектами (хранимая процедура, триггер, функция, представление) и внесёнными изменениями. Должен называться `db_5.sql`.
2. Файл с последовательными SQL-запросами для тестирования каждого объекта. Должен называться `task_5.sql`.

::: details Пример содержимого файла `task_5.sql`

@[code sql:collapsed-lines=5](./includes/exam_task_5.sql)

:::
