# МДК.11.01 - Практический экзамен - Вариант №1

## База данных учёта сотрудников и проектов

Вы работаете с базой данных компании, которая ведёт учёт сотрудников, их проектов и времени, затраченного на выполнение задач. Ваша задача — дополнить существующую базу данных необходимыми объектами, написать SQL-скрипты для выполнения операций над базой данных и продемонстрировать использование хранимых процедур, пользовательских функций, триггеров и представлений.

## Готовая база данных

**Имя базы:** `company_db`

**Таблицы и данные:**

1. **`employees`** — информация о сотрудниках

   | id  | full_name         | birth_date  | position       |
   |-----|-------------------|-------------|----------------|
   | 1   | Иван Иванов       | 1985-02-14  | аналитик       |
   | 2   | Петр Петров       | 1990-08-10  | разработчик    |
   | 3   | Мария Смирнова    | 1987-05-22  | тестировщик    |

2. **`projects`** — информация о проектах

   | id  | project_name      | start_date  | end_date       |
   |-----|-------------------|-------------|----------------|
   | 1   | CRM-система       | 2023-01-01  | 2023-12-31     |
   | 2   | Веб-приложение    | 2023-03-01  | NULL           |

3. **`employee_projects`** — участие сотрудников в проектах

   | id  | employee_id | project_id | role          | hours_worked |
   |-----|-------------|------------|---------------|--------------|
   | 1   | 1           | 1          | аналитик      | 120          |
   | 2   | 2           | 1          | разработчик   | 200          |
   | 3   | 3           | 2          | тестировщик   | 80           |

4. **`project_changes`** — журнал изменений (изначально пустая)

   | id  | project_id | operation | operation_time |
   |-----|------------|-----------|----------------|

5. **`change_logs`** — журнал изменений в системе

   | id  | entity_id | old_value | new_value | change_time |
   |-----|-----------|-----------|-----------|-------------|

Для создания соответствующей БД используйте SQL-скрипт:

::: details company_db.sql

@[code sql:collapsed-lines=5](./includes/exam_var_1_data.sql)

:::

## Задачи

1. **Разработать хранимую процедуру `assign_employee_to_project`**:
   - **Параметры:**
     - `p_employee_id` — идентификатор сотрудника.
     - `p_project_id` — идентификатор проекта.
     - `p_role` — роль сотрудника.
     - `p_hours` — количество часов.
   - **Логика работы:**
     - Проверяет существование сотрудника в таблице `employees` и проекта в таблице `projects`.
       - Если сотрудник или проект не найдены, возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Сотрудник или проект не найдены';
         ```

     - Проверяет, не участвует ли сотрудник уже в указанном проекте.
       - Если сотрудник участвует в проекте, возвращает варнинг:

         ```sql
         SIGNAL SQLSTATE '01000' SET MESSAGE_TEXT = 'Сотрудник уже участвует в проекте';
         ```

       - Данные при этом не добавляются.
     - **Если проверки прошли успешно**:
       - Добавляет запись в таблицу `employee_projects`.
       - Логирует успешное добавление записи в таблицу `project_changes` с операцией `assign`.
       - Все действия должны быть реализованы с использованием транзакции.
     - В случае любой другой ошибки **откатывает транзакцию**.

2. **Создать пользовательскую функцию `get_project_count_for_employee`**:
   - **Параметр:**
     - `p_employee_id` — идентификатор сотрудника.
   - **Возвращает:** количество проектов, в которых участвует сотрудник.
   - Если сотрудник не найден, возвращает `0` как результат без генерации ошибок.

3. **Создать триггер `log_project_update` для таблицы `projects`**:
   - **Срабатывает:**
     - При любом обновлении записи в таблице `projects`.
   - **Действие:**
     - Логирует изменения в таблицу `change_logs`.
     - Добавляет в лог следующие данные:
       - `entity_id` — ID изменённого проекта.
       - `old_value` — предыдущее название проекта.
       - `new_value` — новое название проекта.
       - `change_time` — момент изменения.

4. **Создать представление `employee_project_summary`**:
   - **Выводит:**
     - `full_name` — ФИО сотрудника.
     - `position` — должность.
     - `project_name` — название проекта.
     - `hours_worked` — количество отработанных часов.
   - **Логика работы:** объединяет данные из таблиц `employees`, `projects` и `employee_projects`.

## Результат

Задание должно быть выполнено в локальной файловой системе компьютера. Папка со всеми файлами задания должна называться:

__`МДК.11.01 - Вариант 1 - Иванов И.И.`__

где вместо `Иванов И.И.` должны быть указаны фамилия и инициалы сдающего.

Результат выполнения задания должен быть оформлен в виде файлов:

1. Файл дампа итоговой базы данных с созданными объектами (хранимая процедура, триггер, функция, представление) и внесёнными изменениями. Должен называться `db_1.sql`.
2. Файл с последовательными SQL-запросами для тестирования каждого объекта. Должен называться `task_1.sql`.

::: details Пример содержимого файла `task_1.sql`

@[code sql:collapsed-lines=5](./includes/exam_task_1.sql)

:::
