# МДК.11.01 - Практический экзамен - Вариант №3

## База данных автосалона

Вы работаете с базой данных автосалона, который ведёт учёт автомобилей, клиентов, менеджеров и заказов. Ваша задача - дополнить существующую базу данных необходимыми объектами, написать SQL-скрипты для выполнения операций над базой данных и продемонстрировать использование хранимых процедур, пользовательских функций, триггеров и представлений.

## Готовая база данных

**Имя базы:** `car_dealership_db`

**Таблицы и данные:**

1. **`cars`** — информация об автомобилях

   | id  | vin               | model           | mileage | price   | status     |
   |-----|-------------------|-----------------|---------|---------|------------|
   | 1   | 1HGCM82633A123456 | Toyota Camry    | 20000   | 2500000 | available  |
   | 2   | WBA3A5C58DF123457 | BMW X5          | 10000   | 5500000 | available  |
   | 3   | KM8J3CA46KU123458 | Hyundai Solaris | 15000   | 1200000 | available  |

2. **`clients`** — информация о клиентах

   | id  | full_name          | phone         |
   |-----|--------------------|---------------|
   | 1   | Алексей Смирнов    | 8007001111    |
   | 2   | Елена Кузнецова    | 8007002222    |
   | 3   | Дмитрий Павлов     | 8007003333    |

3. **`managers`** — информация о менеджерах

   | id  | full_name         | phone         | commission_rate |
   |-----|-------------------|---------------|-----------------|
   | 1   | Иван Иванов       | 8005551234    | 0.01            |
   | 2.  | Пётр Петров       | 8005555678    | 0.02            |

4. **`orders`** — информация о заказах (изначально пустая)

   | id  | client_id | car_id | manager_id | order_date  | total |
   |-----|-----------|--------|------------|-------------|-------|

5. **`change_logs`** — журнал изменений в системе

   | id  | entity_id | old_value | new_value | change_time |
   |-----|-----------|-----------|-----------|-------------|

Для создания соответствующей БД используйте SQL-скрипт:

::: details car_dealership_db.sql

@[code sql:collapsed-lines=5](./includes/exam_var_3_data.sql)

:::

## Задачи

1. **Разработать хранимую процедуру `sell_car`**:
   - **Параметры:**
     - `p_client_id` — идентификатор клиента.
     - `p_car_id` — идентификатор автомобиля.
     - `p_manager_id` — идентификатор менеджера.
   - **Логика работы:**
     - Проверяет существование клиента, автомобиля и менеджера в соответствующих таблицах.
       - Если клиент, автомобиль или менеджер не найдены, возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Клиент, автомобиль или менеджер не найдены';
         ```

     - Проверяет, доступен ли автомобиль для продажи (статус `available`).
       - Если автомобиль уже продан (статус `sold`), возвращает варнинг (проверять другие статусы не обязательно из-за `ENUM`):

         ```sql
         SIGNAL SQLSTATE '01000' SET MESSAGE_TEXT = 'Автомобиль уже продан';
         ```

     - Если проверки прошли успешно:
       - Обновляет статус автомобиля на `sold` в таблице `cars`.
       - Добавляет запись о заказе в таблицу `orders` с указанием общей суммы (`total = price`), и устанавливает дату заказа (`order_date`).
       - Все действия должны быть реализованы с использованием транзакции.
     - В случае любой другой ошибки откатывает транзакцию.

2. **Создать пользовательскую функцию `calculate_commission`**:
   - **Параметр:**
     - `p_order_id` — идентификатор заказа.
   - **Возвращает:** размер комиссии менеджера за конкретный заказ (вычисляется как `total * commission_rate`).
   - Если заказ не найден, функция возвращает `0` без генерации ошибок.

3. **Создать триггер `log_car_status_update` для таблицы `cars`**:
   - **Срабатывает:**
     - При изменении статуса автомобиля.
   - **Действие:**
     - Логирует изменения в таблицу `change_logs`.
     - Записывает:
       - `entity_id` — ID автомобиля.
       - `old_value` — предыдущий статус (`available` или `sold`).
       - `new_value` — новый статус (`available` или `sold`).
       - `change_time` — момент изменения.

4. **Создать представление `manager_sales_summary`**:
   - **Выводит:**
     - `manager_name` — ФИО менеджера.
     - `total_cars_sold` — общее количество проданных автомобилей.
     - `total_commission` — общая сумма комиссий менеджера.
   - **Логика работы:** объединяет данные из таблиц `managers`, `cars` и `orders`.

## Результат

Задание должно быть выполнено в локальной файловой системе компьютера. Папка со всеми файлами задания должна называться:

__`МДК.11.01 - Вариант 3 - Иванов И.И.`__

где вместо `Иванов И.И.` должны быть указаны фамилия и инициалы сдающего.

Результат выполнения задания должен быть оформлен в виде файлов:

1. Файл дампа итоговой базы данных с созданными объектами (хранимая процедура, триггер, функция, представление) и внесёнными изменениями. Должен называться `db_3.sql`.
2. Файл с последовательными SQL-запросами для тестирования каждого объекта. Должен называться `task_3.sql`.

::: details Пример содержимого файла `task_3.sql`

@[code sql:collapsed-lines=5](./includes/exam_task_3.sql)

:::
