# МДК.11.01 - 22 - Представления

Примеры данной темы используют учебную БД:

::: tabs

@tab Структура БД

@[code mermaid](./includes/transactions_example_updated.mermaid)

@tab Дамп

@[code sql:collapsed-lines=10](./includes/transactions_example_updated.sql)

@tab Таблицы

  ::: tabs

  @tab **users**
  <!-- @include: ./includes/transactions_example_updated_table_users.md -->

  @tab **accounts**
  <!-- @include: ./includes/transactions_example_updated_table_accounts.md -->

  @tab **transactions**
  <!-- @include: ./includes/transactions_example_updated_table_transactions.md -->

  :::

:::

MySQL 8 предоставляет мощный инструментарий для работы с представлениями (вьюхами). Представления — это виртуальные таблицы, которые основаны на результатах выполнения запросов к другим таблицам. Они позволяют упростить сложные запросы, создавая логические структуры данных, которые можно использовать в дальнейшем.

Представления (Views) в MySQL — это виртуальные таблицы, которые основаны на результатах выполнения запроса `SELECT`. Они представляют собой логические структуры данных, которые могут быть использованы для упрощения и оптимизации запросов к базе данных.

Основная цель использования представлений в MySQL — это абстрагирование сложных запросов и создание более простых и понятных интерфейсов для работы с данными. Вместо того, чтобы каждый раз писать сложные запросы, можно создать представление, которое будет содержать уже готовый запрос. После этого можно обращаться к представлению как к обычной таблице, выполнять `SELECT`-запросы к нему и получать результаты.

Преимущества использования представлений в MySQL:

1. Упрощение сложных запросов: представления позволяют создавать запросы с большим количеством таблиц и условий, а затем использовать их как обычные таблицы, что делает код более читаемым и понятным.

2. Обеспечение безопасности: представления могут быть использованы для ограничения доступа к определенным столбцам или строкам таблицы. Например, можно создать представление, которое будет содержать только определенные столбцы таблицы и предоставить доступ к этому представлению, скрывая остальные данные.

3. Улучшение производительности: представления могут быть использованы для оптимизации запросов. Например, можно создать представление, которое будет содержать сложный запрос с использованием JOIN и фильтрацией данных. Затем можно использовать это представление вместо повторного выполнения сложного запроса каждый раз, когда требуется получить данные.

4. Логическая абстракция: представления позволяют создавать логические структуры данных, которые могут быть использованы для упрощения работы с данными. Например, можно создать представление, которое будет содержать объединение нескольких таблиц и предоставлять простой интерфейс для работы с этими данными.

В целом, представления в MySQL — это инструмент для упрощения и оптимизации запросов к базе данных, а также для обеспечения безопасности и логической абстракции данных.

Для создания представления в MySQL 8 используется конструкция `CREATE VIEW`. Рассмотрим несколько примеров.

**Пример 1: Создание простого представления**

Предположим, у нас есть таблица `users` с полями `id`, `name` и `age`. Мы хотим создать представление, которое будет отображать только имена пользователей старше 30 лет.

```sql
CREATE VIEW older_users AS
SELECT name, age
FROM users
WHERE age > 30;
```

Теперь мы можем использовать представление `older_users` вместо написания запроса каждый раз:

```sql
SELECT * FROM older_users;
```

**Пример 2: Обновление данных через представление**

Представления в MySQL 8 могут быть не только для чтения, но и для обновления данных. Рассмотрим пример с таблицей `accounts`, где у каждого счета есть поле `balance`. Мы хотим создать представление, которое будет отображать только счета на которых больше хранится больше `10000`.

```sql
CREATE VIEW high_balance AS
SELECT *
FROM accounts
WHERE balance > 10000;
```

Теперь мы можем обновлять данные через представление. Например, допустим в силу вступила новая бонусная программа в рамках которой на все счета на которых больше `10000` начисляется бонус в размере `5%` от соответствующей суммы, однако со счетами на которых хранится меньше указанной суммы, бонусная программа не распространяется. Тогда можно это решить через представление:

```sql
UPDATE high_balance
SET balance = balance + (balance * 0.05)
WHERE id > 0;
```

Таким образом, запрос `UPDATE` сработает только для того набора данных, который входит в данное представление.

::: info

В данном примере `WHERE id > 0` нужен для того чтобы формально выполнить требование наличия в условии первичного ключа при обновлении данных, дабы избежать ошибки `Error Code: 1175. You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column. To disable safe mode, toggle the option in Preferences -> SQL Editor and reconnect.` (само собой, отключение `safe mode` в нашем случае будет излишней мерой)

:::

**Пример 3: Использование JOIN в представлениях**

Представления могут быть основаны на нескольких таблицах и использовать операторы `JOIN`. Рассмотрим пример создания представления, которое будет включать данные о транзакции и имя владельца счета для всех транзакций типа `deposit`. Можно использовать следующий запрос:

```sql
CREATE VIEW deposit_transactions AS
SELECT
   transactions.id,
   transactions.date_time,
   transactions.amount,
   transactions.transaction_type,
   users.name AS account_owner
FROM transactions
JOIN accounts ON transactions.account_id = accounts.id
JOIN users ON accounts.user_id = users.id
WHERE transactions.transaction_type = 'deposit';
```

После выполнения этого запроса будет создано представление с именем `deposit_transactions`, которое будет содержать следующие данные:

- `id` - идентификатор транзакции
- `date_time` - дата и время транзакции
- `amount` - сумма транзакции
- `transaction_type` - тип транзакции (в данном случае будет равен `deposit`)
- `account_owner` - имя владельца счета

Теперь можно использовать это представление для получения данных о всех транзакциях типа `deposit` вместе с именем владельца счета:

```sql
SELECT * FROM deposit_transactions;
```

Этот запрос вернет список всех транзакций типа `deposit` вместе с именем владельца счета для каждой транзакции.

В заключение, представления в MySQL 8 — это мощный инструмент для упрощения работы с данными и повышения производительности запросов. Они позволяют создавать логические структуры данных и использовать их как обычные таблицы.
