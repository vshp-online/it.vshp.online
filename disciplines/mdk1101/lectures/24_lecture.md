# МДК.11.01 - 24 - Создание пользователей и назначение привилегий

Примеры данной темы используют учебную БД:

::: tabs

@tab Структура БД

@[code mermaid](./includes/transactions_example_updated.mermaid)

@tab Дамп

@[code sql:collapsed-lines=10](./includes/transactions_example_updated.sql)

@tab Таблицы

  ::: tabs

  @tab **users**
  <!-- @include: ./includes/transactions_example_updated_table_users.md -->

  @tab **accounts**
  <!-- @include: ./includes/transactions_example_updated_table_accounts.md -->

  @tab **transactions**
  <!-- @include: ./includes/transactions_example_updated_table_transactions.md -->

  :::

:::

В информационных системах безопасность данных является одним из важнейших аспектов. При работе с базой данных MySQL, рекомендуется следовать принципу наименьших привилегий и создавать пользователей с ограниченным доступом к базе данных. Администратор MySQL должен создавать такие учетные записи для "обычных" пользователей и определять их права доступа. Это позволяет предоставлять пользователям только те привилегии, которые им действительно необходимы для работы, и обеспечивать безопасность данных. Кроме того, проведение аудита полномочий и корректировка их при необходимости также являются важными шагами для обеспечения безопасности базы данных.

## Создание пользователя

Новый пользователь в MySQL добавляется командой:

```sql
CREATE USER 'имя_пользователя'@'имя_хоста' IDENTIFIED BY 'уникальный_пароль';
```

Теперь давайте создадим нашего первого пользователя:

```sql
CREATE USER 'test'@'localhost' IDENTIFIED BY 'PaSsWoRd';
```

Эта команда выполняет следующие действия:

- Создание пользователя `test` с доступом только с локального хоста `localhost`.
- Пользователь будет иметь пароль `PaSsWoRd`.

::: warning

Имейте ввиду, что добавленный таким образом пользователь не будет обладать какими-либо привилегиями кроме возможности подключиться к серверу БД.

:::

Убедиться в отсутствии каких-либо привилегий мы можем даже не подключаясь к серверу от его имени, достаточно вспомнить материалы прошлой темы и воспользоваться запросом (не забываем про модификатор `\G` если работаем напрямую через терминал):

```sql
SELECT * FROM mysql.user WHERE User = 'test' AND Host = 'localhost';
```

А чтобы добавить пользователю какие-либо привилегии, необходимо добавить пользователю необходимые привилегии вручную, либо явно указать их при создании.

## Удаление пользователя

Давайте для начала удалим нашего "бесполезного" пользователя. Сделать это можно при помощи команды `DROP`:

```sql
DROP USER 'test'@'localhost';
```

::: tip

Для команды создания и удаления пользователя также будут работать конструкции проверки существования `IF EXISTS` и `IF NOT EXISTS` дабы избежать ошибок.

:::

## Создание дополнительного суперпользователя

Это не самая лучшая практика, но бывают ситуации, когда может потребоваться несколько разных суперпользователей (например, различающихся хостом или способом авторизации). В MySQL добавить дополнительного пользователя с правами `root` можно так:

```sql
CREATE USER 'admin'@'%' IDENTIFIED BY 'PaSsWoRd';
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

Данная команда используется для предоставления полных привилегий пользователю `admin` на все базы данных и все таблицы в MySQL.

::: warning

Имейте ввиду, что команде `GRANT` в любом случае нужен пользователь, и если такого пользователя не существует, он автоматически будет создан, однако, в таком случае способ авторизации и пароль для такого пользователя придется устанавливать отдельно. Имейте ввиду, что **по-умолчанию MySQL 8 настроена так чтобы избегать этой ситуации**, при попытке создать такого пользователя, вы скорее всего увидите ошибку: `Error Code: 1410. You are not allowed to create a user with GRANT`

:::

Давайте разберемся, что означает каждая часть этой команды:

- `GRANT ALL PRIVILEGES`: Эта часть команды указывает, что мы хотим предоставить все привилегии пользователю.
- `ON *.*`: Здесь указывается, на какие базы данных и таблицы будут распространяться предоставленные привилегии. Знак `*` перед точкой означает "все базы данных", а знак `*` после точки означает "все таблицы".
- `TO 'admin'@'%'`: В этой части указывается имя пользователя и его хост. В данном случае, пользователь с именем `admin` будет иметь эти привилегии. Символ `%` означает, что пользователь может подключаться к серверу с любого хоста.
- `WITH GRANT OPTION`: Эта часть указывает, что пользователь `admin` сможет предоставлять эти же привилегии другим пользователям.

Таким образом, после выполнения этой команды пользователь `admin` будет иметь полный доступ ко всем базам данных и таблицам в MySQL, и сможет также предоставлять эти же привилегии другим пользователям.

::: note

Обратите внимание также на команду `FLUSH PRIVILEGES` -- она дает серверу команду пересчитать действующие привилегии. Как правило, она нужна не только при использовании команд `GRANT`, `REVOKE`, `SET PASSWORD` и `RENAME USER`, но и в случае прямой модификации привилегий с служебных таблицах баз данных `information_schema` и `mysql`. Иными словами, команда `FLUSH PRIVILEGES` применяет все изменения в привилегиях, которые были внесены, что гарантирует, что новый пользователь будет иметь доступ к базам данных и таблицам, для которых ему были предоставлены соответствующие привилегии.

:::

## Отзыв всех привилегий у суперпользователя

Команда отзыва привилегий функционально обратна `GRANT`, с той лишь разницей что `TO` заменяется на `FROM`. Давайте попробуем лишить нашего созданного ранее суперпользователя всех привилегий и возможности предоставления другим:

```sql
REVOKE ALL PRIVILEGES, GRANT OPTION FROM 'admin'@'%';
FLUSH PRIVILEGES;
```

После чего, если данный пользователь больше не нужен, его вполне можно удалить:

```sql
DROP USER 'admin'@'%';
```

## Создание пользователей с конкретным набором привилегий

Примеры создания пользователей с разными привилегиями для работы с базой данных, для каждого уровня:

1. У пользователя полный доступ только к этой БД:

```sql
CREATE USER 'bank_db_admin'@'localhost' IDENTIFIED BY 'PaSsWoRd_1';
GRANT ALL PRIVILEGES ON bank_db.* TO 'bank_db_admin'@'localhost';
FLUSH PRIVILEGES;
```

Типовые запросы для проверки:

```sql
SELECT * FROM accounts;
INSERT INTO accounts (title, user_id, balance) VALUES ('Тестовый', 1, 100);
UPDATE accounts SET title = 'Тестовый счёт' WHERE id = 6;
DELETE FROM accounts WHERE id = 6;
```

2. У пользователя доступ только к одной таблице на выбор, добавление, обновление и удаление значений:

```sql
CREATE USER 'bank_db_manager'@'localhost' IDENTIFIED BY 'PaSsWoRd_2';
GRANT SELECT, INSERT, UPDATE, DELETE ON bank_db.transactions TO 'bank_db_manager'@'localhost';
FLUSH PRIVILEGES;
```

Типовые запросы для проверки:

```sql
SELECT * FROM transactions;
```

3. У пользователя доступ только к двум столбцам только на чтение:

```sql
CREATE USER 'bank_db_inspector'@'localhost' IDENTIFIED BY 'PaSsWoRd_3';
GRANT SELECT(user_id, balance) ON bank_db.accounts TO 'bank_db_inspector'@'localhost';
FLUSH PRIVILEGES;
```

Типовые запросы для проверки:

```sql
SELECT user_id, balance FROM accounts;
```

## Отзыв конкретного набора привилегий у пользователя

Допустим, нам необходимо отозвать у пользователя `'bank_db_manager'@'localhost'` возможность добавлять и удалять данные, оставим только возможность их запрашивать и обновлять:

```sql
REVOKE INSERT, DELETE ON bank_db.transactions FROM 'bank_db_manager'@'localhost';
FLUSH PRIVILEGES;
```

Аналогичным образом будет работать отзыв всех привилегий, на примере утратившего доверие пользователя `'bank_db_admin'@'localhost'`:

```sql
REVOKE ALL PRIVILEGES ON bank_db.* FROM 'bank_db_admin'@'localhost';
FLUSH PRIVILEGES;
```
