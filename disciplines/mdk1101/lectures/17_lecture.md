# МДК.11.01 - 17 - Введение в хранимые процедуры

Примеры данной темы используют учебную БД:

::: tabs

@tab Структура БД

@[code mermaid](./includes/transactions_example.mermaid)

@tab Дамп

@[code sql:collapsed-lines=10](./includes/transactions_example.sql)

@tab Таблицы

  ::: tabs

  @tab **users**
  <!-- @include: ./includes/transactions_example_table_users.md -->

  @tab **accounts**
  <!-- @include: ./includes/transactions_example_table_accounts.md -->

  :::

:::

MySQL 8 предоставляет возможность создания и использования хранимых процедур, которые являются набором инструкций, объединенных в единую единицу. Хранимые процедуры позволяют упростить и структурировать работу с базой данных, а также повысить безопасность и эффективность выполнения операций.

Хранимая процедура MySQL представляет собой *подпрограмму*, хранящуюся в базе данных. Она содержит имя, список параметров и операторы SQL. Все популярные системы управления базами данных поддерживают хранимые процедуры. Они были введены в MySQL 5.

Существует два вида подпрограмм: **хранимые процедуры** и **функции**, возвращающие значения, которые используются в других операторах SQL.

Основное отличие заключается в том, что функции могут использоваться, как любое другое выражение в операторах SQL, а хранимые процедуры должны вызываться с помощью оператора `CALL`.

Хранимые процедуры MySQL работают быстро. Преимущество сервера MySQL заключается в том, что он использует кэширование, а также заранее заданные операторы. Основной прирост скорости дает сокращение сетевого трафика. Если есть повторяющиеся задачи, которые требуют проверки, обработки циклов, нескольких операторов, и при этом не требуют взаимодействия с пользователем, это можно реализовать с помощью одного вызова процедуры, которая хранится на сервере.

Исходный код хранимых процедур всегда доступен в базе данных. Это эффективная практика связать данные с процессами, которые их обрабатывают.

---

Пример создания хранимой процедуры без параметров:

```sql
DELIMITER $$
CREATE PROCEDURE ShowAllUsers()
BEGIN
    SELECT * FROM users;
END $$
DELIMITER ;
```

В данном примере создается хранимая процедура `ShowAllUsers`, которая выполняет запрос на выборку всех данных из таблицы `users`.

Вызвать такую процедуру можно командой:

```sql
CALL ShowAllUsers();
```

::: warning

Обратите внимание на конструкцию `DELIMITER $$` и `DELIMITER ;` — очевидно, что хранимые процедуры могут состоять из нескольких SQL-запросов, которые необходимо разделять, и чтобы не было конфликта с символом `;` который по-умолчанию разделяет запросы (чтобы он не прервал сам запрос на создание процедуры), на время создания процедуры принято задавать временный разделитель, например `$$` чтобы `;` можно было использовать внутри самой процедуры, а после того как процедура задана, значение разделителя возвращается. В качестве разделителя может быть задан почти любой символ или последовательность кроме "пробела", но чаще всего принято задавать `$$` или `//`.

:::

Пример хранимой процедуры с параметром на ввод:

```sql
DELIMITER $$
CREATE PROCEDURE GetUser(IN userID INT)
BEGIN
    SELECT * FROM users WHERE id = userID;
END $$
DELIMITER ;
```

В данном примере создается хранимая процедура `GetUser`, которая принимает входной параметр `userID` и выполняет запрос на выборку данных из таблицы `users` по указанному идентификатору пользователя.

Вызвать такую процедуру можно командой:

```sql
CALL GetUser(1);
```

Здесь, мы получим данные пользователя с `ID = 1`;

::: info

Параметры бывают трёх типов: `IN`, `OUT` и `INOUT`, или параметры ввода, параметры вывода и параметры ввода-вывода соответственно. Параметры ввода — это те что процедура принимает, параметры вывода — те что процедура возвращает по факту своего вызова, а параметры ввода-вывода — те что могут менять свое значение в процессе вызова. Кроме того, важно чтобы для каждого параметра в процедуре был задан его тип.

:::

Пример хранимой процедуры с параметром на вывод:

```sql
DELIMITER $$
CREATE PROCEDURE CountUsers(OUT usersCount INT)
BEGIN
    SELECT COUNT(*) AS countInt INTO usersCount FROM users;
END $$
DELIMITER ;
```

Данная хранимая процедура считает количество пользователей и возвращает их в виде выходного параметра `usersCount`. Выходные параметры, как правило, служат для их дальнейшего присвоения переменным.

Вызвать такую процедуру можно командой:

```sql
SET @usersCount = 0;
CALL CountUsers(@usersCount);
SELECT @usersCount;
```

Обратите внимание, что для начала мы создали переменную `@usersCount` и задали ей некоторое начальное значение `0`, после чего вызвали процедуру, передав ей переменную в качестве некоторого "контейнера" в которую будет положен выходной параметр. После вызова процедуры, это значение присвоилось переменной, что мы впоследствии и увидели при помощи `SELECT`.

Удалить неиспользуемую процедуру можно при помощи команды:

```sql
DROP PROCEDURE CountUsers;
```

При этом для удаления процедуры не нужно передавать каких-либо аргументов или использоваться скобки.

---

Пример хранимой процедуры с параметром `INOUT`:

```sql
DELIMITER $$

CREATE PROCEDURE CalculateFixedTax (
  INOUT amount DECIMAL(10,2)
)
BEGIN
  SELECT amount * 0.2 INTO amount;
END $$

DELIMITER ;
```

В данном примере мы написали хранимую процедуру которая рассчитывает фиксированную ставку НДС, составляющую `20%` от переданной суммы. Результат возвращается в ту же самую переменную в которой хранилось исходной значение, что упрощает использование в рамках более сложных конструкций (например если исходное значение получено другой хранимой процедурой).

Такую хранимую процедуру мы можем вызвать следующим образом:

```sql
SET @amount = 10500;
CALL CalculateFixedTax(@amount);
SELECT @amount;
```

Здесь мы передали некоторую сумму для расчета налога в переменной `@amount`, и после вызова хранимой процедуры и расчета налога, результат будет записал в ту же переменную.

---

Пример хранимой процедуры с несколькими параметрами `IN` и `OUT`:

```sql
DELIMITER $$

CREATE PROCEDURE GetUserBalance(
  IN userID INT,
  OUT userBalance DECIMAL(10,2),
  OUT userName VARCHAR(255)
)
BEGIN

  SELECT SUM(balance) INTO userBalance
  FROM accounts
  WHERE user_id = userID;

  SELECT name INTO userName
  FROM users
  WHERE id = userID;

END $$

DELIMITER ;
```

В данной хранимой процедуре `GetUserBalance` объявляются три параметра: `userID` типа `INT`, `userBalance` типа `DECIMAL(10,2)` и `userName` типа `VARCHAR(255)`.

Процедура сначала получает сумму баланса пользователя, при помощи функции `SUM(balance)` для переданного `userID`. Значение суммы баланса присваивается переменной `userBalance` с помощью оператора `SELECT INTO`.

Затем процедура получает имя пользователя для переданного `userID`. Имя пользователя присваивается переменной `userName` с помощью оператора `SELECT INTO`.

Таким образом, после выполнения процедуры, значения переменных `userBalance` и `userName` будут содержать соответствующие значения баланса пользователя и его имени.

Пример вызова процедуры, например для пользователя с `ID = 2`:

```sql
SET @userBalance = 0;
SET @userName = '';
CALL GetUserBalance(2, @userBalance, @userName);
SELECT @userBalance, @userName;
```

::: info

Во многих СУБД также существует возможность посмотреть из каких запросов состоит хранимая процедура и как она была создана.
Для этого используется команда: `SHOW CREATE PROCEDURE ИмяХранимойПроцедуры;`.

:::
