# МДК.11.01 - Практический экзамен - Вариант №4

## База данных гостиницы

Вы работаете с базой данных гостиницы, которая ведёт учёт номеров, гостей, сотрудников и бронирований. Ваша задача — дополнить существующую базу данных необходимыми объектами, написать SQL-скрипты для выполнения операций над базой данных и продемонстрировать использование хранимых процедур, пользовательских функций, триггеров и представлений.

## Готовая база данных

**Имя базы:** `hotel_db`

**Таблицы и данные:**

1. **`rooms`** — информация о номерах

   | id  | room_number | room_type | price_per_day | status     |
   |-----|-------------|-----------|---------------|------------|
   | 1   | 101         | standard  | 3000.00       | available  |
   | 2   | 202         | deluxe    | 5000.00       | available  |
   | 3   | 303         | suite     | 8000.00       | available  |

2. **`guests`** — информация о гостях

   | id  | full_name          | phone         |
   |-----|--------------------|---------------|
   | 1   | Иван Иванов        | 8007001111    |
   | 2   | Мария Смирнова     | 8007002222    |

3. **`employees`** — информация о сотрудниках

   | id  | full_name         | position       |
   |-----|-------------------|----------------|
   | 1   | Анна Кузнецова    | администратор  |
   | 2   | Сергей Волков     | менеджер       |

4. **`bookings`** — информация о бронированиях (изначально пустая)

   | id  | guest_id | room_id | employee_id | check_in_date | check_out_date | total_cost |
   |-----|----------|---------|-------------|---------------|----------------|------------|

5. **`change_logs`** — журнал изменений в системе

   | id  | entity_id | old_value | new_value | change_time |
   |-----|-----------|-----------|-----------|-------------|

Для создания соответствующей БД используйте SQL-скрипт:

::: details hotel_db.sql

@[code sql:collapsed-lines=5](./includes/exam_var_4_data.sql)

:::

## Задачи

1. **Разработать хранимую процедуру `book_room`**:
   - **Параметры:**
     - `p_guest_id` — идентификатор гостя.
     - `p_room_id` — идентификатор номера.
     - `p_employee_id` — идентификатор сотрудника.
     - `p_check_in_date` — дата заселения.
     - `p_check_out_date` — дата выселения.
   - **Логика работы:**
     - Проверяет существование гостя, номера и сотрудника.
       - Если гость, номер или сотрудник не найдены, возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Гость, номер или сотрудник не найдены';
         ```

     - Проверяет, доступен ли номер для бронирования (статус `available`).
       - Если номер уже забронирован, возвращает ошибку:

         ```sql
         SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Номер уже забронирован';
         ```

     - **Если проверки прошли успешно**:
       - Вычисляет общую стоимость проживания как `(количество дней * price_per_day)`.
       - Добавляет запись о бронировании в таблицу `bookings` с указанием всех параметров.
       - Обновляет статус номера на `booked` в таблице `rooms`.
       - Все действия должны быть реализованы с использованием транзакции.
     - В случае любой ошибки **откатывает транзакцию**.

2. **Создать пользовательскую функцию `calculate_stay_cost`**:
   - **Параметры:**
     - `p_room_id` — идентификатор номера.
     - `p_days` — количество дней проживания.
   - **Возвращает:** стоимость проживания для указанного номера и количества дней.
   - Если номер не найден, функция возвращает `0` без генерации ошибок.

3. **Создать триггер `log_room_status_update` для таблицы `rooms`**:
   - **Срабатывает:**
     - При изменении статуса номера.
   - **Действие:**
     - Логирует изменения в таблицу `change_logs`.
     - Записывает:
       - `entity_id` — ID номера.
       - `old_value` — предыдущий статус (`available` или `booked`).
       - `new_value` — новый статус (`available` или `booked`).
       - `change_time` — момент изменения.

4. **Создать представление `employee_booking_summary`**:
   - **Выводит:**
     - `employee_name` — ФИО сотрудника.
     - `total_bookings` — количество бронирований, оформленных сотрудником.
     - `total_revenue` — общая сумма по бронированиям.
   - **Логика работы:** объединяет данные из таблиц `employees`, `rooms` и `bookings`.

## Результат

Задание должно быть выполнено в локальной файловой системе компьютера. Папка со всеми файлами задания должна называться:

__`МДК.11.01 - Вариант 4 - Иванов И.И.`__

где вместо `Иванов И.И.` должны быть указаны фамилия и инициалы сдающего.

Результат выполнения задания должен быть оформлен в виде файлов:

1. Файл дампа итоговой базы данных с созданными объектами (хранимая процедура, триггер, функция, представление) и внесёнными изменениями. Должен называться `db_4.sql`.
2. Файл с последовательными SQL-запросами для тестирования каждого объекта. Должен называться `task_4.sql`.

::: details Пример содержимого файла `task_4.sql`

@[code sql:collapsed-lines=5](./includes/exam_task_4.sql)

:::
