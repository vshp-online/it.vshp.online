import{_ as d,c as k,b as n,d as c,a as m,w as e,r as u,o as v,e as s}from"./app-DiDl7sIA.js";const b={};function y(E,a){const r=u("Mermaid"),i=u("Tabs");return v(),k("div",null,[a[8]||(a[8]=n("h1",{id:"мдк-11-01-19-транзакции-и-обработка-ошибок-в-хранимых-процедурах",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#мдк-11-01-19-транзакции-и-обработка-ошибок-в-хранимых-процедурах"},[n("span",null,"МДК.11.01 - 19 - Транзакции и обработка ошибок в хранимых процедурах")])],-1)),a[9]||(a[9]=n("p",null,"Примеры данной темы используют учебную БД:",-1)),c(i,{data:[{id:"Структура БД"},{id:"Дамп"},{id:"Таблицы"}]},{title0:e(({value:t,isActive:p})=>[...a[0]||(a[0]=[s("Структура БД",-1)])]),title1:e(({value:t,isActive:p})=>[...a[1]||(a[1]=[s("Дамп",-1)])]),title2:e(({value:t,isActive:p})=>[...a[2]||(a[2]=[s("Таблицы",-1)])]),tab0:e(({value:t,isActive:p})=>[c(r,{code:"eJxLLXLJTEwvSszlUlAoLU4tKlaoBrIUFDz9QhQyUxQCvMG8MMcgZw/HIIW8xNxUoEAtECcmJ+eX5pXgV1+SWZID0gCRB5kfD1TkBlHk4urs6evoo5CUmJOYlwwzF+KImhpd3fxqhCVWCkoX9l3YcmHHhb26F3Zd2Kd7Yc+FvUCRzUCRPUpcAN0zQl0="})]),tab1:e(({value:t,isActive:p})=>[...a[3]||(a[3]=[n("div",{class:"language-sql line-numbers-mode has-collapsed-lines collapsed","data-highlighter":"prismjs","data-ext":"sql",style:{"--vp-collapsed-lines":"10"}},[n("pre",null,[n("code",{class:"language-sql"},[n("span",{class:"line"},[n("span",{class:"token keyword"},"SET"),s(" foreign_key_checks "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"DROP"),s(),n("span",{class:"token keyword"},"TABLE"),s(),n("span",{class:"token keyword"},"IF"),s(),n("span",{class:"token keyword"},"EXISTS"),s(" users"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"DROP"),s(),n("span",{class:"token keyword"},"TABLE"),s(),n("span",{class:"token keyword"},"IF"),s(),n("span",{class:"token keyword"},"EXISTS"),s(" accounts"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"CREATE"),s(),n("span",{class:"token keyword"},"TABLE"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("users"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token punctuation"},"(")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("id"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"INT"),s(),n("span",{class:"token operator"},"NOT"),s(),n("span",{class:"token boolean"},"NULL"),s(),n("span",{class:"token keyword"},"AUTO_INCREMENT"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("name"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"VARCHAR"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"255"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"NOT"),s(),n("span",{class:"token boolean"},"NULL"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"PRIMARY"),s(),n("span",{class:"token keyword"},"KEY"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("id"),n("span",{class:"token punctuation"},"`")]),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"LOCK"),s(),n("span",{class:"token keyword"},"TABLES"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("users"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"WRITE"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"INSERT"),s(),n("span",{class:"token keyword"},"INTO"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("users"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"VALUES"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Иванов Иван Иванович'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Петров Петр Петрович'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Сидоров Сидор Сидорович'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"UNLOCK"),s(),n("span",{class:"token keyword"},"TABLES"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"CREATE"),s(),n("span",{class:"token keyword"},"TABLE"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("accounts"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token punctuation"},"(")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("id"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"INT"),s(),n("span",{class:"token operator"},"NOT"),s(),n("span",{class:"token boolean"},"NULL"),s(),n("span",{class:"token keyword"},"AUTO_INCREMENT"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("title"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"VARCHAR"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"255"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"DEFAULT"),s(),n("span",{class:"token boolean"},"NULL"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("user_id"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"INT"),s(),n("span",{class:"token operator"},"NOT"),s(),n("span",{class:"token boolean"},"NULL"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("balance"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"DECIMAL"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"NOT"),s(),n("span",{class:"token boolean"},"NULL"),s(),n("span",{class:"token keyword"},"DEFAULT"),s(),n("span",{class:"token string"},"'0.00'"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"PRIMARY"),s(),n("span",{class:"token keyword"},"KEY"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("id"),n("span",{class:"token punctuation"},"`")]),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"KEY"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("user_id_idx"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("user_id"),n("span",{class:"token punctuation"},"`")]),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"CONSTRAINT"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("user_id"),n("span",{class:"token punctuation"},"`")])]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"FOREIGN"),s(),n("span",{class:"token keyword"},"KEY"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("user_id"),n("span",{class:"token punctuation"},"`")]),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"REFERENCES"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("users"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("id"),n("span",{class:"token punctuation"},"`")]),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"ON"),s(),n("span",{class:"token keyword"},"DELETE"),s(),n("span",{class:"token keyword"},"CASCADE")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"ON"),s(),n("span",{class:"token keyword"},"UPDATE"),s(),n("span",{class:"token keyword"},"CASCADE")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"LOCK"),s(),n("span",{class:"token keyword"},"TABLES"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("accounts"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"WRITE"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"INSERT"),s(),n("span",{class:"token keyword"},"INTO"),s(),n("span",{class:"token identifier"},[n("span",{class:"token punctuation"},"`"),s("accounts"),n("span",{class:"token punctuation"},"`")]),s(),n("span",{class:"token keyword"},"VALUES"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Основной'"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"10500.00"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Резервный'"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"3412.57"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Основной'"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"20750.00"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Основной'"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"25000.00"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},"'Накопительный'"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"5401.75"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"UNLOCK"),s(),n("span",{class:"token keyword"},"TABLES"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"SET"),s(" foreign_key_checks "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"})])]),n("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})]),n("div",{class:"collapsed-lines"})],-1)])]),tab2:e(({value:t,isActive:p})=>[c(i,{data:[{id:"<strong>users</strong>"},{id:"<strong>accounts</strong>"}]},{title0:e(({value:l,isActive:o})=>[...a[4]||(a[4]=[n("strong",null,"users",-1)])]),title1:e(({value:l,isActive:o})=>[...a[5]||(a[5]=[n("strong",null,"accounts",-1)])]),tab0:e(({value:l,isActive:o})=>[...a[6]||(a[6]=[n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"right"}},"id"),n("th",{style:{"text-align":"left"}},"name")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"right"}},"1"),n("td",{style:{"text-align":"left"}},"Иванов Иван Иванович")]),n("tr",null,[n("td",{style:{"text-align":"right"}},"2"),n("td",{style:{"text-align":"left"}},"Петров Петр Петрович")]),n("tr",null,[n("td",{style:{"text-align":"right"}},"3"),n("td",{style:{"text-align":"left"}},"Сидоров Сидор Сидорович")])])],-1)])]),tab1:e(({value:l,isActive:o})=>[...a[7]||(a[7]=[n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"right"}},"id"),n("th",{style:{"text-align":"left"}},"title"),n("th",{style:{"text-align":"right"}},"user_id"),n("th",{style:{"text-align":"right"}},"balance")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"right"}},"1"),n("td",{style:{"text-align":"left"}},"Основной"),n("td",{style:{"text-align":"right"}},"1"),n("td",{style:{"text-align":"right"}},"10500")]),n("tr",null,[n("td",{style:{"text-align":"right"}},"2"),n("td",{style:{"text-align":"left"}},"Резервный"),n("td",{style:{"text-align":"right"}},"1"),n("td",{style:{"text-align":"right"}},"3412.57")]),n("tr",null,[n("td",{style:{"text-align":"right"}},"3"),n("td",{style:{"text-align":"left"}},"Основной"),n("td",{style:{"text-align":"right"}},"2"),n("td",{style:{"text-align":"right"}},"20750")]),n("tr",null,[n("td",{style:{"text-align":"right"}},"4"),n("td",{style:{"text-align":"left"}},"Основной"),n("td",{style:{"text-align":"right"}},"3"),n("td",{style:{"text-align":"right"}},"25000")]),n("tr",null,[n("td",{style:{"text-align":"right"}},"5"),n("td",{style:{"text-align":"left"}},"Накопительный"),n("td",{style:{"text-align":"right"}},"2"),n("td",{style:{"text-align":"right"}},"5401.75")])])],-1)])]),_:2},1024)]),_:1}),a[10]||(a[10]=m(`<h2 id="транзакции-в-хранимых-процедурах" tabindex="-1"><a class="header-anchor" href="#транзакции-в-хранимых-процедурах"><span>Транзакции в хранимых процедурах</span></a></h2><p>Использование транзакций в хранимых процедурах в MySQL 8 позволяет обеспечить целостность данных и контроль над выполнением операций. Транзакции позволяют выполнять группу операций как единое целое, при этом можно откатить все изменения, если происходит ошибка, или подтвердить изменения, если все операции прошли успешно.</p><p>Пример использования транзакций с операторами <code>ROLLBACK</code> и <code>COMMIT</code> на основе условия <code>IF</code>:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">DELIMITER</span> $$</span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> TransferMoney<span class="token punctuation">(</span></span>
<span class="line">  <span class="token operator">IN</span> accountFrom <span class="token keyword">INT</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token operator">IN</span> accountTo <span class="token keyword">INT</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token operator">IN</span> amountMoney <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token comment">-- Объявление переменных</span></span>
<span class="line">    <span class="token keyword">DECLARE</span> balanceAmount <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">SELECT</span> balance <span class="token keyword">INTO</span> balanceAmount</span>
<span class="line">    <span class="token keyword">FROM</span> accounts <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountFrom<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">-- Начало транзакции</span></span>
<span class="line">    <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">UPDATE</span> accounts</span>
<span class="line">    <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> amountMoney</span>
<span class="line">    <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountFrom<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">UPDATE</span> accounts</span>
<span class="line">    <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> amountMoney</span>
<span class="line">    <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountTo<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">IF</span> balanceAmount <span class="token operator">&gt;=</span> amountMoney <span class="token keyword">THEN</span></span>
<span class="line">        <span class="token keyword">SELECT</span> balanceAmount<span class="token punctuation">,</span> amountMoney<span class="token punctuation">,</span> <span class="token string">&#39;Можем перевести, фиксируем транзакцию&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">ELSE</span></span>
<span class="line">        <span class="token keyword">SELECT</span> balanceAmount<span class="token punctuation">,</span> amountMoney<span class="token punctuation">,</span> <span class="token string">&#39;Не можем перевести, откатываем транзакцию&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">END</span> $$</span>
<span class="line"><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Данная хранимая процедура <code>TransferMoney</code> предназначена для перевода денежных средств между двумя счетами в таблице <code>accounts</code>. Процедура принимает входные параметры: <code>accountFrom</code> (идентификатор счета, с которого нужно списать деньги), <code>accountTo</code> (идентификатор счета, на который нужно зачислить деньги) и <code>amountMoney</code> (сумма денег для перевода).</p><p>Процедура объявляет переменную <code>balanceAmount</code> типа <code>DECIMAL(10,2)</code>, в которую будет сохранено текущее значение баланса счета <code>accountFrom</code>.<br> Затем она начинает транзакцию с помощью оператора <code>START TRANSACTION</code>.</p><p>Далее происходят два обновления таблицы <code>accounts</code>. С помощью оператора <code>UPDATE</code> происходит уменьшение баланса на счету <code>accountFrom</code> на указанную сумму <code>amountMoney</code> и увеличение баланса на счету <code>accountTo</code> на эту же сумму.</p><p>После этого происходит проверка условия <code>IF balanceAmount &gt;= amountMoney</code>. Если текущий баланс на счете <code>accountFrom</code> больше или равен сумме <code>amountMoney</code>, то процедура выводит значения <code>balanceAmount, amountMoney</code> и сообщение <code>&quot;Можем перевести, фиксируем транзакцию&quot;</code> с помощью оператора <code>SELECT</code>. Затем транзакция подтверждается с помощью оператора <code>COMMIT</code>.</p><p>Если же текущий баланс на счете <code>accountFrom</code> меньше суммы <code>amountMoney</code>, то процедура выводит значения <code>balanceAmount, amountMoney</code> и сообщение <code>&quot;Не можем перевести, откатываем транзакцию&quot;</code>. Затем транзакция откатывается с помощью оператора <code>ROLLBACK</code>.</p><p>Как и ранее, вызвать хранимую процедуру можно командой:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">CALL</span> TransferMoney<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Здесь мы переводим со счета с <code>ID = 2</code> на счет с <code>ID = 1</code> ровно <code>1000</code> рублей.</p><p>Таким образом, данная хранимая процедура позволяет переводить деньги между счетами с проверкой наличия достаточного баланса на счете <code>accountFrom</code> и обеспечивает целостность данных благодаря использованию транзакций.</p><h2 id="обработка-ошибок-в-хранимых-процедурах" tabindex="-1"><a class="header-anchor" href="#обработка-ошибок-в-хранимых-процедурах"><span>Обработка ошибок в хранимых процедурах</span></a></h2><p>В MySQL 8 обработка ошибок осуществляется с помощью определенных конструкций, нацеленных на обработку исключений а также на генерацию специальных ошибок.</p><p>Пример кода обработки исключения:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">DELIMITER</span> $$</span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> ExceptionTest<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLEXCEPTION</span>
<span class="line">    <span class="token keyword">BEGIN</span></span>
<span class="line">        GET DIAGNOSTICS CONDITION <span class="token number">1</span> <span class="token variable">@p1</span> <span class="token operator">=</span> RETURNED_SQLSTATE<span class="token punctuation">,</span> <span class="token variable">@p2</span> <span class="token operator">=</span> MESSAGE_TEXT<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span><span class="token variable">@p1</span><span class="token punctuation">,</span> <span class="token string">&#39;:&#39;</span><span class="token punctuation">,</span> <span class="token variable">@p2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">END</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">SELECT</span> FAKE_COLUMN <span class="token keyword">FROM</span> MY_TABLE<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span> $$</span>
<span class="line"><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>В данном коде создается хранимая процедура с названием <code>ExceptionTest()</code>. Внутри процедуры определен обработчик исключений для ошибок, возникающих при выполнении SQL-запросов. Если происходит исключение <code>SQLEXCEPTION</code>, то внутри обработчика получаются диагностические данные, такие как код ошибки <code>RETURNED_SQLSTATE</code> и текст сообщения об ошибке <code>MESSAGE_TEXT</code>. Затем происходит вывод этих данных в формате <code>&quot;код ошибки:текст сообщения&quot;</code>. В конце процедуры выполняется SQL-запрос, который вызывает ошибку, пытаясь выбрать несуществующую колонку <code>FAKE_COLUMN</code> из таблицы <code>MY_TABLE</code>.</p><p>Комплексный пример генерации специальных ошибок:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">DELIMITER</span> $$</span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> ComplexErrorTest<span class="token punctuation">(</span><span class="token operator">IN</span> exceptionState <span class="token keyword">INT</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">  <span class="token keyword">DECLARE</span> specialty CONDITION <span class="token keyword">FOR</span> SQLSTATE <span class="token string">&#39;45000&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">IF</span> exceptionState <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">THEN</span></span>
<span class="line">    SIGNAL SQLSTATE <span class="token string">&#39;01000&#39;</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;Предупреждение: значение равно нулю&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">ELSEIF</span> exceptionState <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span></span>
<span class="line">    SIGNAL SQLSTATE <span class="token string">&#39;45000&#39;</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;Ошибка: произошла ошибка&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">ELSEIF</span> exceptionState <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">THEN</span></span>
<span class="line">    SIGNAL specialty <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;Ошибка: произошла специальная ошибка&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">ELSE</span></span>
<span class="line">    <span class="token comment">-- Не покажется, потому что Warning имеет более низкий приоритет</span></span>
<span class="line">    SIGNAL SQLSTATE <span class="token string">&#39;01000&#39;</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;Предупреждение: произошла предупреждение&#39;</span><span class="token punctuation">,</span> MYSQL_ERRNO <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">-- Покажется, потому что Error имеет более высокий приоритет</span></span>
<span class="line">    SIGNAL SQLSTATE <span class="token string">&#39;45000&#39;</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;Ошибка: произошла ошибка&#39;</span><span class="token punctuation">,</span> MYSQL_ERRNO <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span> $$</span>
<span class="line"><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Процедура принимает один входной параметр типа <code>INT</code>. Внутри процедуры проверяется значение параметра и в зависимости от него генерируются различные предупреждения и ошибки. Если значение параметра равно <code>0</code>, генерируется предупреждение с текстом <code>&quot;Предупреждение: значение равно нулю&quot;</code>. Если значение параметра равно <code>1</code>, генерируется ошибка с текстом <code>&quot;Ошибка: произошла ошибка&quot;</code>. Если значение параметра равно <code>2</code>, генерируется специальная ошибка с текстом <code>&quot;Ошибка: произошла специальная ошибка&quot;</code>. Во всех остальных случаях генерируются предупреждение с текстом <code>&quot;Предупреждение: произошла предупреждение&quot;</code> и пользовательским кодом ошибки <code>1000</code>, а также ошибка с текстом <code>&quot;Ошибка: произошла ошибка&quot;</code> и пользовательским кодом ошибки <code>1001</code>.</p><hr><h2 id="задание-для-самопроверки" tabindex="-1"><a class="header-anchor" href="#задание-для-самопроверки"><span>Задание для самопроверки</span></a></h2><p>Напишите хранимую процедуру перевода денежных средств с одного счета на другой с учётом того хватит ли денег на счету с которого пытаются перевести деньги. Используйте механизм транзакций и обработку ошибок.</p><details class="hint-container details"><summary>Решение задачи - Перевод денежных средств с учетом остатков</summary><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">DELIMITER</span> $$</span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> TransferMoney<span class="token punctuation">(</span></span>
<span class="line">  <span class="token operator">IN</span> accountFrom <span class="token keyword">INT</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token operator">IN</span> accountTo <span class="token keyword">INT</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token operator">IN</span> amountMoney <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token comment">-- Объявление переменных</span></span>
<span class="line">    <span class="token keyword">DECLARE</span> balanceAmount <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">DECLARE</span> accountID <span class="token keyword">INT</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">SELECT</span> id <span class="token keyword">INTO</span> accountID</span>
<span class="line">    <span class="token keyword">FROM</span> accounts <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountTo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">SELECT</span> balance <span class="token keyword">INTO</span> balanceAmount</span>
<span class="line">    <span class="token keyword">FROM</span> accounts <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountFrom<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">-- Начало транзакции</span></span>
<span class="line">    <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">UPDATE</span> accounts</span>
<span class="line">    <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> amountMoney</span>
<span class="line">    <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountFrom<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">UPDATE</span> accounts</span>
<span class="line">    <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> amountMoney</span>
<span class="line">    <span class="token keyword">WHERE</span> id <span class="token operator">=</span> accountTo<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">IF</span> accountID <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">IF</span> balanceAmount <span class="token operator">&gt;=</span> amountMoney <span class="token keyword">THEN</span></span>
<span class="line">      <span class="token keyword">SELECT</span> balanceAmount<span class="token punctuation">,</span> amountMoney<span class="token punctuation">,</span> <span class="token string">&#39;Можем перевести, фиксируем транзакцию&#39;</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">ELSE</span></span>
<span class="line">      <span class="token comment">-- SELECT balanceAmount, amountMoney, &#39;Не можем перевести, откатываем транзакцию&#39;;</span></span>
<span class="line">      <span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span></span>
<span class="line">      SIGNAL SQLSTATE <span class="token string">&#39;01000&#39;</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;Предупреждение: не хватает денежных средств&#39;</span><span class="token punctuation">,</span> MYSQL_ERRNO <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">ELSE</span></span>
<span class="line">    <span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span></span>
<span class="line">        SIGNAL SQLSTATE <span class="token string">&#39;45000&#39;</span> <span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">&#39;ОШИБКА: ТАКОГО АККАУНТА НЕТ!&#39;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">END</span> $$</span>
<span class="line"><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details>`,25))])}const w=d(b,[["render",y]]),g=JSON.parse('{"path":"/disciplines/mdk1101/lectures/19_lecture.html","title":"МДК.11.01 - 19 - Транзакции и обработка ошибок в хранимых процедурах","lang":"ru-RU","frontmatter":{"description":"МДК.11.01 - 19 - Транзакции и обработка ошибок в хранимых процедурах Примеры данной темы используют учебную БД: Транзакции в хранимых процедурах Использование транзакций в храни...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"МДК.11.01 - 19 - Транзакции и обработка ошибок в хранимых процедурах\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-10-24T14:30:06.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://it.vshp.online/disciplines/mdk1101/lectures/19_lecture.html"}],["meta",{"property":"og:site_name","content":"Кафедра ИТ"}],["meta",{"property":"og:title","content":"МДК.11.01 - 19 - Транзакции и обработка ошибок в хранимых процедурах"}],["meta",{"property":"og:description","content":"МДК.11.01 - 19 - Транзакции и обработка ошибок в хранимых процедурах Примеры данной темы используют учебную БД: Транзакции в хранимых процедурах Использование транзакций в храни..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ru-RU"}],["meta",{"property":"og:updated_time","content":"2025-10-24T14:30:06.000Z"}],["meta",{"property":"article:modified_time","content":"2025-10-24T14:30:06.000Z"}]]},"git":{"updatedTime":1761316206000,"contributors":[{"name":"PAVEL TKACHEV","username":"","email":"phoenixweiss@ya.ru","commits":1}],"changelog":[{"hash":"7164abf5ea181652ae6e18935015af58c1253ed4","time":1761316206000,"email":"phoenixweiss@ya.ru","author":"PAVEL TKACHEV","message":"Update 14_lecture.md, 15_lecture.md, 16_lecture.md, and 16 more files"}]},"autoDesc":true,"filePathRelative":"disciplines/mdk1101/lectures/19_lecture.md"}');export{w as comp,g as data};
